{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PageTurner - Create Book</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <!-- Navbar -->
  <header class="bg-purple-800 text-white shadow-md z-10 relative">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <img src="{% static 'images/purple_logo.png' %}" alt="PageTurner Logo" class="h-10 w-auto">
        <span class="text-2xl font-semibold tracking-wide">PageTurner</span>
      </div>
      <nav class="space-x-6">
        <a href="/" class="hover:text-purple-300 transition">Home</a>
        <a href="/system/" class="hover:text-purple-300 transition">System</a>
        <a href="/project/" class="hover:text-purple-300 transition">Data Project</a>
        <a href="/about/" class="hover:text-purple-300 transition">About</a>
        <a href="/api/docs" class="bg-white text-purple-800 px-3 py-1 rounded hover:bg-yellow-400 transition font-semibold shadow-sm">üìò API Doc</a>
      </nav>
    </div>
  </header>

  <!-- Header -->
  <section class="bg-white border-b border-gray-200">
    <div class="max-w-3xl mx-auto px-4 py-8">
      <h1 class="text-3xl md:text-4xl font-bold text-purple-700">Create Book</h1>
      <p class="mt-2 text-gray-700 text-sm">
        Fill in all required fields.<br>
        <span class="font-semibold">Tips:</span><br>
        - Title and authors will be converted to <em>Title Case</em>.<br>
        - Multiple authors: separate them with <code class="bg-gray-100 px-1 py-0.5 rounded">/</code>.<br>
        - Use <strong>.</strong> as the decimal separator in ratings and reviews.<br>
        - Date must be in a valid calendar format.
      </p>
    </div>
  </section>

  <!-- Content -->
  <main class="max-w-3xl mx-auto px-4 py-8">
    <!-- Messages -->
    <div id="alertBox" class="hidden mb-6 rounded-lg border p-4 flex items-center justify-between"></div>

    <!-- Form -->
    <form id="bookForm" class="space-y-6 bg-white p-6 rounded-xl shadow border border-gray-200">
      <div>
        <label class="block font-medium text-sm text-gray-700">ID (book_id) *</label>
        <input type="number" id="book_id" required class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
      </div>

      <div>
        <label class="block font-medium text-sm text-gray-700">Title *</label>
        <input type="text" id="title" required class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
      </div>

      <div>
        <label class="block font-medium text-sm text-gray-700">Authors (separate with /) *</label>
        <input type="text" id="authors_raw" required class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
      </div>

      <div>
        <label class="block font-medium text-sm text-gray-700">Average Rating *</label>
        <input type="text" id="average_rating" required placeholder="e.g.: 4.57" class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block font-medium text-sm text-gray-700">ISBN</label>
          <input type="text" id="isbn" class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
        </div>
        <div>
          <label class="block font-medium text-sm text-gray-700">ISBN13</label>
          <input type="text" id="isbn13" class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
        </div>
      </div>

      <div>
        <label class="block font-medium text-sm text-gray-700">Language (e.g.: eng, pt-BR)</label>
        <input type="text" id="language_code" class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
      </div>

      <div>
        <label class="block font-medium text-sm text-gray-700">Number of Pages</label>
        <input type="number" id="num_pages" min="1" class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block font-medium text-sm text-gray-700">Review Count</label>
          <input type="number" id="text_reviews_count" class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
        </div>
        <div>
          <label class="block font-medium text-sm text-gray-700">Rating Count</label>
          <input type="number" id="ratings_count" class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
        </div>
      </div>

      <div>
        <label class="block font-medium text-sm text-gray-700">Publication Date</label>
        <input type="date" id="publication_date" class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
      </div>

      <div>
        <label class="block font-medium text-sm text-gray-700">Publisher</label>
        <input type="text" id="publisher" class="mt-1 w-full border rounded-md px-3 py-2 focus:ring-purple-500 focus:border-purple-500">
      </div>

      <div>
        <button type="submit" class="w-full bg-purple-700 text-white py-3 rounded-md font-semibold hover:bg-purple-800 transition">Save</button>
      </div>
    </form>
  </main>

  <!-- Footer -->
  <footer class="bg-purple-900 text-white text-sm text-center py-4">
    &copy; 2025 PageTurner. Developed by
    <a href="https://shamslux.github.io/ShamsluxTechVault/" target="_blank" class="underline hover:text-purple-300">Shamslux</a>.
  </footer>

<script>
  const API_URL = '/api/books/'; // üîë with trailing slash
  const $ = (sel) => document.querySelector(sel);

  // CSRF helper (only needed if your Ninja API is not csrf=False)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function setAlert(type, msg) {
    const box = $('#alertBox');
    if (!msg) { box.className = 'hidden'; box.innerHTML = ''; return; }

    const base = 'mb-6 rounded-lg border p-4 flex items-center justify-between ';
    const styles = {
      info:  base + 'border-blue-200 bg-blue-50 text-blue-900',
      warn:  base + 'border-yellow-200 bg-yellow-50 text-yellow-900',
      error: base + 'border-red-200 bg-red-50 text-red-900',
      ok:    base + 'border-green-200 bg-green-50 text-green-900',
    };
    const icons = { info: '‚ÑπÔ∏è', warn: '‚ö†Ô∏è', error: '‚ùå', ok: '‚úîÔ∏è' };

    box.className = styles[type] || styles.info;
    box.innerHTML = `
      <div class="flex items-center gap-2">
        <span>${icons[type] || icons.info}</span>
        <span>${msg}</span>
      </div>
      <button onclick="setAlert()" class="ml-4 text-sm font-semibold hover:underline">Close</button>
    `;

    // auto-hide after a while
    window.clearTimeout(box.__timer);
    box.__timer = window.setTimeout(() => setAlert(), 7000);
  }

  function toTitleCase(str) {
    return String(str || '').replace(/\w\S*/g, (txt) =>
      txt.charAt(0).toUpperCase() + txt.slice(1).toLowerCase()
    );
  }

  // ---- Normalizers / parsers ----
  function valOrNull(s) {
    const t = (s ?? '').trim();
    return t === '' ? null : t;
  }
  function intOrNull(v) {
    const n = Number.parseInt(v, 10);
    return Number.isFinite(n) ? n : null;
  }
  function decimalOrNull(v) {
    // Accepts dot-decimal only. Empty => null. Comma => NaN (invalid).
    const t = typeof v === 'string' ? v.trim() : '';
    if (!t) return null;
    if (t.includes(',')) return NaN;
    const n = Number(t);
    return Number.isFinite(n) ? n : NaN;
  }

  function findMissingRequired(data) {
    const missing = [];
    // Accept 0 as a valid book_id too (leading zeros like "0000" -> 0)
    if (data.book_id == null || !Number.isInteger(data.book_id) || data.book_id < 0) {
      missing.push('book_id');
    }
    if (!data.title || String(data.title).trim().length === 0) {
      missing.push('title');
    }
    if (!data.authors_raw || String(data.authors_raw).trim().length === 0) {
      missing.push('authors_raw');
    }
    if (data.average_rating == null || Number.isNaN(data.average_rating)) {
      missing.push('average_rating');
    }
    return missing;
  }


  $('#bookForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setAlert();

    // Read raw values first (useful for debugging)
    const raw = {
      book_id: $('#book_id')?.value,
      title: $('#title')?.value,
      authors_raw: $('#authors_raw')?.value,
      average_rating: $('#average_rating')?.value,
      isbn: $('#isbn')?.value,
      isbn13: $('#isbn13')?.value,
      language_code: $('#language_code')?.value,
      num_pages: $('#num_pages')?.value,
      text_reviews_count: $('#text_reviews_count')?.value,
      ratings_count: $('#ratings_count')?.value,
      publication_date: $('#publication_date')?.value,
      publisher: $('#publisher')?.value,
    };

    // Build payload with normalization
    const data = {
      book_id: intOrNull(raw.book_id),
      title: toTitleCase((raw.title || '').trim()),
      authors_raw: toTitleCase((raw.authors_raw || '').trim()),
      average_rating: decimalOrNull(raw.average_rating),
      isbn: valOrNull(raw.isbn),
      isbn13: valOrNull(raw.isbn13),
      language_code: valOrNull(raw.language_code),
      num_pages: intOrNull(raw.num_pages),
      text_reviews_count: intOrNull(raw.text_reviews_count),
      ratings_count: intOrNull(raw.ratings_count),
      publication_date: valOrNull(raw.publication_date), // 'YYYY-MM-DD' or null
      publisher: valOrNull(raw.publisher),
    };

    // Debug to console to see exactly what is being sent
    console.debug('[CreateBook] raw:', raw);
    console.debug('[CreateBook] normalized data:', data);

    // Required fields check with explicit feedback
    const missing = findMissingRequired(data);
    if (missing.length > 0) {
      setAlert('warn', `Please fill in all required fields. Missing/invalid: <strong>${missing.join(', ')}</strong>.`);
      return;
    }

    // Headers (include CSRF token if cookie exists)
    const headers = { 'Content-Type': 'application/json' };
    const csrftoken = getCookie('csrftoken');
    if (csrftoken) headers['X-CSRFToken'] = csrftoken;

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers,
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        let detail = '';
        try {
          const j = await res.json();
          if (j && typeof j === 'object') {
            if (j.detail) {
              detail = typeof j.detail === 'string' ? j.detail : JSON.stringify(j.detail);
            } else {
              detail = JSON.stringify(j);
            }
          }
        } catch {
          detail = await res.text();
        }
        throw new Error(detail || `HTTP Error ${res.status}`);
      }

      const saved = await res.json();
      setAlert('ok', `Book successfully created: <strong>${saved.title}</strong> (ID ${saved.book_id})`);
      $('#bookForm').reset();
    } catch (err) {
      setAlert('error', `Failed to save: ${err.message}`);
    }
  });
</script>


</body>
</html>
